<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #0066FF;
        }

        .tab-btn.active {
            color: #0066FF;
            border-bottom-color: #0066FF;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #0066FF;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .export-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .export-section h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-csv {
            background: #28a745;
            color: white;
        }

        .btn-csv:hover {
            background: #218838;
        }

        .btn-json {
            background: #17a2b8;
            color: white;
        }

        .btn-json:hover {
            background: #138496;
        }

        .btn-analysis {
            background: #6f42c1;
            color: white;
        }

        .btn-analysis:hover {
            background: #5a32a3;
        }

        .data-table {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .insight-box {
            background: #e3f2fd;
            border-left: 4px solid #0066FF;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .insight-box h4 {
            color: #0066FF;
            margin-bottom: 10px;
        }

        .insight-box ul {
            margin-left: 20px;
            color: #333;
        }

        .insight-box li {
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Analytics Dashboard</h1>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Loading data...</div>

        <div id="content" style="display: none;">
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('pricing')">Van Westendorp</button>
                <button class="tab-btn" onclick="switchTab('pain')">Pain Analysis</button>
                <button class="tab-btn" onclick="switchTab('priorities')">JTBD Priorities</button>
                <button class="tab-btn" onclick="switchTab('tools')">Tools & Demographics</button>
                <button class="tab-btn" onclick="switchTab('referrals')">Referrals</button>
                <button class="tab-btn" onclick="switchTab('export')">Export Data</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Responses</div>
                        <div class="stat-value" id="totalResponses">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value" id="completionRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Interest</div>
                        <div class="stat-value" id="avgInterest">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Median Price</div>
                        <div class="stat-value" id="medianPrice">$0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Interest Score Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="interestChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Commitment Levels</h3>
                    <div class="chart-wrapper">
                        <canvas id="commitmentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Van Westendorp Tab -->
            <div id="pricing-tab" class="tab-content">
                <div class="insight-box" id="pricingInsights">
                    <h4>ðŸ’¡ Pricing Insights</h4>
                    <ul id="pricingInsightsList"></ul>
                </div>

                <div class="chart-container">
                    <h3>Van Westendorp Price Sensitivity Analysis</h3>
                    <div class="chart-wrapper">
                        <canvas id="vanWestendorpChart"></canvas>
                    </div>
                </div>

                <div class="data-table">
                    <h3>Pricing Statistics</h3>
                    <table id="pricingStatsTable"></table>
                </div>
            </div>

            <!-- Pain Analysis Tab -->
            <div id="pain-tab" class="tab-content">
                <div class="insight-box" id="painInsights">
                    <h4>ðŸ’¡ Key Pain Points</h4>
                    <ul id="painInsightsList"></ul>
                </div>

                <div class="chart-container">
                    <h3>Pain Score Averages (1-10 Scale)</h3>
                    <div class="chart-wrapper">
                        <canvas id="painChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Pain Score Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="painDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- JTBD Priorities Tab -->
            <div id="priorities-tab" class="tab-content">
                <div class="insight-box" id="jtbdInsights">
                    <h4>ðŸ’¡ Priority Insights</h4>
                    <ul id="jtbdInsightsList"></ul>
                </div>

                <div class="chart-container">
                    <h3>JTBD Priority Rankings</h3>
                    <div class="chart-wrapper">
                        <canvas id="jtbdChart"></canvas>
                    </div>
                </div>

                <div class="data-table">
                    <h3>Top Priority Reasons</h3>
                    <div id="priorityReasons"></div>
                </div>
            </div>

            <!-- Tools & Demographics Tab -->
            <div id="tools-tab" class="tab-content">
                <div class="chart-container">
                    <h3>AI Tools Usage</h3>
                    <div class="chart-wrapper">
                        <canvas id="toolsChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>User Roles</h3>
                    <div class="chart-wrapper">
                        <canvas id="rolesChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Current Spending Levels</h3>
                    <div class="chart-wrapper">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Referrals Tab -->
            <div id="referrals-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Referrals</div>
                        <div class="stat-value" id="totalReferrals">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rewards Earned</div>
                        <div class="stat-value" id="rewardsEarned">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Viral Coefficient</div>
                        <div class="stat-value" id="viralCoefficient">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Referral Rate</div>
                        <div class="stat-value" id="referralRate">0%</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Referral Funnel</h3>
                    <div class="chart-wrapper">
                        <canvas id="referralFunnelChart"></canvas>
                    </div>
                </div>

                <div class="data-table">
                    <h3>Top Referrers</h3>
                    <table id="topReferrersTable"></table>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export-tab" class="tab-content">
                <div class="export-section">
                    <h3>ðŸ“¥ Export Options</h3>
                    <p style="color: #666; margin-bottom: 20px;">Download survey data in various formats for external analysis</p>

                    <div class="export-buttons">
                        <button class="export-btn btn-csv" onclick="exportCSV()">
                            <span>ðŸ“Š</span> Export CSV
                        </button>
                        <button class="export-btn btn-json" onclick="exportJSON()">
                            <span>{ }</span> Export JSON
                        </button>
                        <button class="export-btn btn-analysis" onclick="exportAnalysisReady()">
                            <span>ðŸ”¬</span> Export for Python/R
                        </button>
                    </div>
                </div>

                <div class="export-section">
                    <h3>ðŸ“‹ What's Included</h3>
                    <ul style="margin-left: 20px; color: #555;">
                        <li><strong>CSV:</strong> All survey responses with 30+ fields, ready for Excel/Google Sheets</li>
                        <li><strong>JSON:</strong> Structured data for programmatic analysis, perfect for Python/R/JavaScript</li>
                        <li><strong>Analysis-Ready:</strong> Pre-processed data with numerical encodings and segments</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rosnhltrmvtlnekqbjos.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvc25obHRybXZ0bG5la3Fiam9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NDI5OTgsImV4cCI6MjA3NzIxODk5OH0.JSCqo0J7uncLXH88LhXBbPd2YWlkRu0rDW59t-INYO0';

        let allResponses = [];
        let charts = {};

        async function loadData() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/survey_responses?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                allResponses = await response.json();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                renderOverview();
                renderVanWestendorp();
                renderPainAnalysis();
                renderJTBDAnalysis();
                renderToolsDemo();
                renderReferrals();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            }
        }

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function renderOverview() {
            const total = allResponses.length;
            document.getElementById('totalResponses').textContent = total;

            const completed = allResponses.filter(r => r.email || r.commitment_level).length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('completionRate').textContent = `${completionRate}%`;

            const interests = allResponses.filter(r => r.interest_rating).map(r => r.interest_rating);
            const avgInterest = interests.length > 0
                ? (interests.reduce((a, b) => a + b, 0) / interests.length).toFixed(1)
                : '0';
            document.getElementById('avgInterest').textContent = avgInterest;

            const bargains = allResponses.filter(r => r.price_bargain).map(r => r.price_bargain).sort((a, b) => a - b);
            const medianPrice = bargains.length > 0
                ? `$${bargains[Math.floor(bargains.length / 2)]}`
                : '$0';
            document.getElementById('medianPrice').textContent = medianPrice;

            // Interest Distribution Chart
            const interestDist = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            interests.forEach(score => {
                if (score >= 1 && score <= 10) {
                    interestDist[score - 1]++;
                }
            });

            charts.interest = new Chart(document.getElementById('interestChart'), {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        label: 'Number of Responses',
                        data: interestDist,
                        backgroundColor: '#0066FF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Commitment Chart
            const commitmentCounts = {};
            allResponses.forEach(r => {
                if (r.commitment_level) {
                    commitmentCounts[r.commitment_level] = (commitmentCounts[r.commitment_level] || 0) + 1;
                }
            });

            charts.commitment = new Chart(document.getElementById('commitmentChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(commitmentCounts),
                    datasets: [{
                        data: Object.values(commitmentCounts),
                        backgroundColor: ['#28a745', '#0066FF', '#ffc107', '#6c757d', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderVanWestendorp() {
            const prices = {
                tooCheap: allResponses.filter(r => r.price_too_cheap).map(r => r.price_too_cheap).sort((a, b) => a - b),
                bargain: allResponses.filter(r => r.price_bargain).map(r => r.price_bargain).sort((a, b) => a - b),
                expensive: allResponses.filter(r => r.price_expensive).map(r => r.price_expensive).sort((a, b) => a - b),
                tooExpensive: allResponses.filter(r => r.price_too_expensive).map(r => r.price_too_expensive).sort((a, b) => a - b)
            };

            // Create price points from 0 to max
            const maxPrice = Math.max(...prices.tooExpensive, 100);
            const pricePoints = [];
            for (let i = 0; i <= maxPrice; i += 5) {
                pricePoints.push(i);
            }

            // Calculate cumulative percentages
            const data = {
                tooCheap: pricePoints.map(p => (prices.tooCheap.filter(x => x <= p).length / prices.tooCheap.length * 100)),
                bargain: pricePoints.map(p => (prices.bargain.filter(x => x <= p).length / prices.bargain.length * 100)),
                expensive: pricePoints.map(p => (prices.expensive.filter(x => x <= p).length / prices.expensive.length * 100)),
                tooExpensive: pricePoints.map(p => (prices.tooExpensive.filter(x => x <= p).length / prices.tooExpensive.length * 100))
            };

            charts.vanWestendorp = new Chart(document.getElementById('vanWestendorpChart'), {
                type: 'line',
                data: {
                    labels: pricePoints,
                    datasets: [
                        {
                            label: 'Too Cheap',
                            data: data.tooCheap,
                            borderColor: '#dc3545',
                            fill: false
                        },
                        {
                            label: 'Bargain',
                            data: data.bargain,
                            borderColor: '#28a745',
                            fill: false
                        },
                        {
                            label: 'Expensive',
                            data: data.expensive,
                            borderColor: '#ffc107',
                            fill: false
                        },
                        {
                            label: 'Too Expensive',
                            data: data.tooExpensive,
                            borderColor: '#dc3545',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Price ($)' }
                        },
                        y: {
                            title: { display: true, text: 'Cumulative %' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // Pricing insights
            const medianBargain = prices.bargain[Math.floor(prices.bargain.length / 2)] || 0;
            const medianExpensive = prices.expensive[Math.floor(prices.expensive.length / 2)] || 0;
            const optimalRange = `$${medianBargain} - $${medianExpensive}`;

            document.getElementById('pricingInsightsList').innerHTML = `
                <li><strong>Optimal Price Range:</strong> ${optimalRange}</li>
                <li><strong>Median Bargain Price:</strong> $${medianBargain}</li>
                <li><strong>Median Expensive Price:</strong> $${medianExpensive}</li>
                <li><strong>Total Price Responses:</strong> ${prices.bargain.length}</li>
            `;

            // Pricing stats table
            const table = document.getElementById('pricingStatsTable');
            table.innerHTML = `
                <tr>
                    <th>Metric</th>
                    <th>Min</th>
                    <th>25th %ile</th>
                    <th>Median</th>
                    <th>75th %ile</th>
                    <th>Max</th>
                </tr>
                <tr>
                    <td><strong>Too Cheap</strong></td>
                    <td>$${Math.min(...prices.tooCheap)}</td>
                    <td>$${prices.tooCheap[Math.floor(prices.tooCheap.length * 0.25)]}</td>
                    <td>$${prices.tooCheap[Math.floor(prices.tooCheap.length * 0.5)]}</td>
                    <td>$${prices.tooCheap[Math.floor(prices.tooCheap.length * 0.75)]}</td>
                    <td>$${Math.max(...prices.tooCheap)}</td>
                </tr>
                <tr>
                    <td><strong>Bargain</strong></td>
                    <td>$${Math.min(...prices.bargain)}</td>
                    <td>$${prices.bargain[Math.floor(prices.bargain.length * 0.25)]}</td>
                    <td>$${medianBargain}</td>
                    <td>$${prices.bargain[Math.floor(prices.bargain.length * 0.75)]}</td>
                    <td>$${Math.max(...prices.bargain)}</td>
                </tr>
                <tr>
                    <td><strong>Expensive</strong></td>
                    <td>$${Math.min(...prices.expensive)}</td>
                    <td>$${prices.expensive[Math.floor(prices.expensive.length * 0.25)]}</td>
                    <td>$${medianExpensive}</td>
                    <td>$${prices.expensive[Math.floor(prices.expensive.length * 0.75)]}</td>
                    <td>$${Math.max(...prices.expensive)}</td>
                </tr>
                <tr>
                    <td><strong>Too Expensive</strong></td>
                    <td>$${Math.min(...prices.tooExpensive)}</td>
                    <td>$${prices.tooExpensive[Math.floor(prices.tooExpensive.length * 0.25)]}</td>
                    <td>$${prices.tooExpensive[Math.floor(prices.tooExpensive.length * 0.5)]}</td>
                    <td>$${prices.tooExpensive[Math.floor(prices.tooExpensive.length * 0.75)]}</td>
                    <td>$${Math.max(...prices.tooExpensive)}</td>
                </tr>
            `;
        }

        function renderPainAnalysis() {
            const painScores = {
                cost: allResponses.filter(r => r.pain_cost).map(r => r.pain_cost),
                quality: allResponses.filter(r => r.pain_quality).map(r => r.pain_quality),
                privacy: allResponses.filter(r => r.pain_privacy).map(r => r.pain_privacy),
                speed: allResponses.filter(r => r.pain_speed).map(r => r.pain_speed),
                reliability: allResponses.filter(r => r.pain_reliability).map(r => r.pain_reliability)
            };

            const averages = {
                cost: painScores.cost.reduce((a, b) => a + b, 0) / painScores.cost.length || 0,
                quality: painScores.quality.reduce((a, b) => a + b, 0) / painScores.quality.length || 0,
                privacy: painScores.privacy.reduce((a, b) => a + b, 0) / painScores.privacy.length || 0,
                speed: painScores.speed.reduce((a, b) => a + b, 0) / painScores.speed.length || 0,
                reliability: painScores.reliability.reduce((a, b) => a + b, 0) / painScores.reliability.length || 0
            };

            charts.pain = new Chart(document.getElementById('painChart'), {
                type: 'bar',
                data: {
                    labels: ['Cost', 'Quality', 'Privacy', 'Speed', 'Reliability'],
                    datasets: [{
                        label: 'Average Pain Score',
                        data: Object.values(averages),
                        backgroundColor: ['#dc3545', '#ffc107', '#6f42c1', '#17a2b8', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: { display: true, text: 'Average Score (1-10)' }
                        }
                    }
                }
            });

            // Pain insights
            const sorted = Object.entries(averages).sort((a, b) => b[1] - a[1]);
            document.getElementById('painInsightsList').innerHTML = sorted.map((item, i) =>
                `<li><strong>#${i + 1} ${item[0].charAt(0).toUpperCase() + item[0].slice(1)}:</strong> ${item[1].toFixed(1)}/10 average pain</li>`
            ).join('');
        }

        function renderJTBDAnalysis() {
            const priorities = {
                Cost: 0,
                Quality: 0,
                Privacy: 0,
                Speed: 0,
                Reliability: 0
            };

            allResponses.forEach(r => {
                if (r.jtbd_rankings) {
                    const ranking = r.jtbd_rankings.split(',').map(s => s.trim());
                    ranking.forEach((item, index) => {
                        if (priorities.hasOwnProperty(item)) {
                            priorities[item] += (5 - index); // Weight by position
                        }
                    });
                }
            });

            charts.jtbd = new Chart(document.getElementById('jtbdChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(priorities),
                    datasets: [{
                        label: 'Weighted Priority Score',
                        data: Object.values(priorities),
                        backgroundColor: '#0066FF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // JTBD insights
            const sorted = Object.entries(priorities).sort((a, b) => b[1] - a[1]);
            document.getElementById('jtbdInsightsList').innerHTML = sorted.map((item, i) =>
                `<li><strong>#${i + 1} ${item[0]}:</strong> Weighted score ${item[1]}</li>`
            ).join('');

            // Top priority reasons
            const reasons = allResponses.filter(r => r.jtbd_why_first).map(r => ({
                priority: r.jtbd_rankings ? r.jtbd_rankings.split(',')[0].trim() : 'Unknown',
                reason: r.jtbd_why_first
            }));

            document.getElementById('priorityReasons').innerHTML = reasons.slice(0, 10).map(r =>
                `<p style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>${r.priority}:</strong> ${r.reason}
                </p>`
            ).join('');
        }

        function renderToolsDemo() {
            // Tools usage
            const toolCounts = {};
            allResponses.forEach(r => {
                if (r.current_tools) {
                    r.current_tools.split(',').forEach(tool => {
                        const t = tool.trim();
                        toolCounts[t] = (toolCounts[t] || 0) + 1;
                    });
                }
            });

            charts.tools = new Chart(document.getElementById('toolsChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(toolCounts),
                    datasets: [{
                        label: 'Number of Users',
                        data: Object.values(toolCounts),
                        backgroundColor: '#0066FF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Roles
            const roleCounts = {};
            allResponses.forEach(r => {
                if (r.role) {
                    roleCounts[r.role] = (roleCounts[r.role] || 0) + 1;
                }
            });

            charts.roles = new Chart(document.getElementById('rolesChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(roleCounts),
                    datasets: [{
                        data: Object.values(roleCounts),
                        backgroundColor: ['#0066FF', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Spending
            const spendingCounts = {};
            allResponses.forEach(r => {
                if (r.current_spending) {
                    spendingCounts[r.current_spending] = (spendingCounts[r.current_spending] || 0) + 1;
                }
            });

            charts.spending = new Chart(document.getElementById('spendingChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(spendingCounts),
                    datasets: [{
                        label: 'Number of Users',
                        data: Object.values(spendingCounts),
                        backgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderReferrals() {
            const totalReferrals = allResponses.reduce((sum, r) => sum + (r.referral_count || 0), 0);
            const rewardsEarned = allResponses.filter(r => r.reward_earned).length;
            const withReferralCode = allResponses.filter(r => r.referral_code).length;
            const viralCoeff = withReferralCode > 0 ? (totalReferrals / withReferralCode).toFixed(2) : '0';
            const referralRate = allResponses.length > 0 ? Math.round((allResponses.filter(r => r.referral_count > 0).length / allResponses.length) * 100) : 0;

            document.getElementById('totalReferrals').textContent = totalReferrals;
            document.getElementById('rewardsEarned').textContent = rewardsEarned;
            document.getElementById('viralCoefficient').textContent = viralCoeff;
            document.getElementById('referralRate').textContent = `${referralRate}%`;

            // Referral funnel
            const noReferrals = allResponses.filter(r => (r.referral_count || 0) === 0).length;
            const oneReferral = allResponses.filter(r => r.referral_count === 1).length;
            const twoReferrals = allResponses.filter(r => r.referral_count >= 2).length;

            charts.referralFunnel = new Chart(document.getElementById('referralFunnelChart'), {
                type: 'bar',
                data: {
                    labels: ['0 Referrals', '1 Referral', '2+ Referrals (Reward!)'],
                    datasets: [{
                        label: 'Number of Users',
                        data: [noReferrals, oneReferral, twoReferrals],
                        backgroundColor: ['#6c757d', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Top referrers
            const topReferrers = allResponses
                .filter(r => r.referral_count > 0)
                .sort((a, b) => b.referral_count - a.referral_count)
                .slice(0, 10);

            const table = document.getElementById('topReferrersTable');
            table.innerHTML = `
                <tr>
                    <th>Rank</th>
                    <th>Email</th>
                    <th>Referrals</th>
                    <th>Reward</th>
                    <th>Referral Code</th>
                </tr>
                ${topReferrers.map((r, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.email || 'Anonymous'}</td>
                        <td>${r.referral_count}/2</td>
                        <td>${r.reward_earned ? 'ðŸŽ‰ Yes' : 'Not yet'}</td>
                        <td><code>${r.referral_code}</code></td>
                    </tr>
                `).join('')}
            `;
        }

        function exportCSV() {
            const headers = [
                'Date', 'Tools', 'Frequency', 'Spending', 'Role',
                'Pain Incident', 'Pain Cost', 'Pain Quality', 'Pain Privacy', 'Pain Speed', 'Pain Reliability',
                'Workarounds', 'JTBD Rankings', 'Why First', 'Why Second',
                'Interest', 'Price Too Cheap', 'Price Bargain', 'Price Expensive', 'Price Too Expensive',
                'Commitment', 'Deal Breakers',
                'Email', 'Name', 'Phone', 'Friend Email 1', 'Friend Email 2',
                'Referral Code', 'Referred By', 'Referral Count', 'Reward Earned'
            ];

            const rows = allResponses.map(r => [
                new Date(r.created_at).toLocaleString(),
                r.current_tools || '',
                r.usage_frequency || '',
                r.current_spending || '',
                r.role || '',
                (r.last_pain_incident || '').replace(/"/g, '""'),
                r.pain_cost || '',
                r.pain_quality || '',
                r.pain_privacy || '',
                r.pain_speed || '',
                r.pain_reliability || '',
                (r.workarounds || '').replace(/"/g, '""'),
                r.jtbd_rankings || '',
                (r.jtbd_why_first || '').replace(/"/g, '""'),
                (r.jtbd_why_second || '').replace(/"/g, '""'),
                r.interest_rating || '',
                r.price_too_cheap || '',
                r.price_bargain || '',
                r.price_expensive || '',
                r.price_too_expensive || '',
                r.commitment_level || '',
                Array.isArray(r.deal_breakers) ? r.deal_breakers.join('; ') : r.deal_breakers || '',
                r.email || '',
                r.name || '',
                r.phone_number || '',
                r.friend_email_1 || '',
                r.friend_email_2 || '',
                r.referral_code || '',
                r.referred_by || '',
                r.referral_count || 0,
                r.reward_earned ? 'Yes' : 'No'
            ]);

            const csv = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            downloadFile(csv, `survey-data-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportJSON() {
            const json = JSON.stringify(allResponses, null, 2);
            downloadFile(json, `survey-data-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportAnalysisReady() {
            // Create analysis-ready format with encoded values
            const analysisData = allResponses.map(r => ({
                id: r.id,
                timestamp: r.created_at,

                // Demographics (encoded)
                tools_cursor: (r.current_tools || '').includes('Cursor') ? 1 : 0,
                tools_copilot: (r.current_tools || '').includes('Copilot') ? 1 : 0,
                tools_claude: (r.current_tools || '').includes('Claude') ? 1 : 0,
                tools_chatgpt: (r.current_tools || '').includes('ChatGPT') ? 1 : 0,

                frequency_encoded: { 'Daily': 5, 'Weekly': 4, 'Monthly': 3, 'Rarely': 2, 'Never': 1 }[r.usage_frequency] || 0,
                spending_encoded: { '$0': 0, '$10-20': 15, '$20-50': 35, '$50+': 75 }[r.current_spending] || 0,
                role_encoded: { 'Developer': 1, 'Manager': 2, 'Founder': 3, 'Student': 4, 'Other': 5 }[r.role] || 0,

                // Pain scores
                pain_cost: r.pain_cost || null,
                pain_quality: r.pain_quality || null,
                pain_privacy: r.pain_privacy || null,
                pain_speed: r.pain_speed || null,
                pain_reliability: r.pain_reliability || null,
                pain_avg: ((r.pain_cost || 0) + (r.pain_quality || 0) + (r.pain_privacy || 0) + (r.pain_speed || 0) + (r.pain_reliability || 0)) / 5,

                // JTBD
                jtbd_rankings: r.jtbd_rankings,
                top_priority: r.jtbd_rankings ? r.jtbd_rankings.split(',')[0].trim() : null,

                // Interest & Pricing
                interest_rating: r.interest_rating || null,
                interested: (r.interest_rating || 0) >= 7 ? 1 : 0,
                price_too_cheap: r.price_too_cheap || null,
                price_bargain: r.price_bargain || null,
                price_expensive: r.price_expensive || null,
                price_too_expensive: r.price_too_expensive || null,
                price_midpoint: ((r.price_bargain || 0) + (r.price_expensive || 0)) / 2,

                // Commitment
                commitment_level: r.commitment_level,
                committed: ['free_premium_early_access', 'preorder'].includes(r.commitment_level) ? 1 : 0,

                // Referrals
                referral_count: r.referral_count || 0,
                reward_earned: r.reward_earned ? 1 : 0,
                was_referred: r.referred_by ? 1 : 0,

                // Contact
                has_email: r.email ? 1 : 0,
                has_phone: r.phone_number ? 1 : 0
            }));

            const json = JSON.stringify(analysisData, null, 2);
            downloadFile(json, `survey-analysis-ready-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
